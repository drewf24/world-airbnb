---
title: "NYC Airbnnb Popularity Factors"
author: "WORLD"
date: "12/15/2019"
output: github_document
---
    
### Load packages & data 

```{r load-packages, message=FALSE}
library(tidyverse) 
library(infer)
library(openintro)
library(dplyr)
library(knitr)
library(broom)
library(tidytext)
```

Uploaded the Airbnb data set from Kaggle via a csv file:

```{r load-data, message=FALSE}
abnb <- read_csv("AB_NYC_2019.csv")
```

Assuming that the data we have for Airbnbs in New York City represents the population. In order to perform the following analysis we used sample_n to randomly select 31 sample observations.

In part I, the following research question will be examined: How does location (borough and neighborhood, for example) influence the price of a listing?

In part II, the following research question will be examined: How does the way in which a property is listed (type of room, for example) influence the availability of a listing?

### Part A

Creating the sample that we will perform the following analysis on:

```{r abnb_sample}
set.seed(111519)
abnb_sample <- sample_n(abnb, 4000)
```

Constructing a bootstrap distribution for the median price of Airbnbs in NYC:

```{r diff_med_income_boot_dist}
set.seed(111519)
boot_dist_median_price <- abnb_sample %>%
  specify(response = price) %>%
  generate(reps = 1000, type = "bootstrap") %>%
  calculate(stat = "median")
```

Creating a 95% bootstrap confidence interval for the the median price of Airbnbs in NYC:

```{r boot_dist_median_priceci}
(ci_bounds <- get_ci(boot_dist_median_price, level= 0.95))
```

We are 95% confident that the population median price per night of Airbnbs in NYC is between $100.00 and $110.00.

Creating a visualizaing of the bootstrap distribution for median price:

```{r boot_dist_median_vis}
visualize(boot_dist_median_price) + 
  labs(title = "Bootstrap Dist of Median Price") +
  shade_ci(ci_bounds)
```

### Part B

Using fct_relevel to make Manhattan the baseline level for neighbourhood_group:

```{r mutate-neighbourhood_group}
abnb_sample <- abnb_sample %>%
  mutate(neighbourhood_group = fct_relevel(neighbourhood_group, 
                                           "Manhattan", 
                                           "Brooklyn",
                                           "Staten Island",
                                           "Queens",
                                           "Bronx"))
```

Creating a linear model to predict Airbnb price by neighbourhood_group:

```{r lm-price-borough}
lm_price_borough <- lm(price ~ neighbourhood_group, data = abnb_sample)

lm_price_borough %>% 
  tidy() %>% 
  select(term, estimate) %>%
  kable(format = "markdown", digits =3)

```

The linear model is:

`price-hat = 206.848 -85.106*(neighbourhood_groupBrooklyn) -117.674*(neighbourhood_groupStaten Island) -110.432*(neighbourhood_groupQueens) -126.213(neighbourhood_groupBronx)`

Intepreting the intercept:

Given that the Airbnb is in Manhattan the expected price, on average, is $206.85. In this case, the intercept does have a meaningful interpretation because an Airbnb could be $206.85 per night.

Interpreting the slopes using lm_price_borough linear model:

For an Airbnb in Brooklyn, the average price is expected, on average, to be $85.11 less than an Airbnb in Manhattan, holding all else constant.

For an Airbnb in Staten Island, the average price is expected, on average, to be $117.67 less than an Airbnb in Manhattan, holding all else constant.

For an Airbnb in Queens, the average price is expected, on average, to be $110.43 less than an Airbnb in Manhattan, holding all else constant.

For an Airbnb in Bronx, the average price is expected, on average, to be $126.21 less than an Airbnb in Manhattan, holding all else constant.

We are now going to add R^2 to our linear model above.

```{r rsqaure-lm_price_borough}
glance(lm_price_borough)$r.squared
```

This means that roughly 3.670% of the variability in average price can be explained by the neighborhood type of Airbnbs in New York City.

### Part C

We are suspicious that there might be a relationship between median price in Manhattan and Brooklyn because they contain the largest amount and the most expensive Airbnbs. Therefore we will attempt to answer the following: Is there is a difference in the true median prices between Manhattan and Brooklyn?

```{r filter-borough}
abnb_sample_filtered <- abnb_sample %>%
  filter(neighbourhood_group == "Manhattan" | neighbourhood_group == "Brooklyn")
```

```{r sample_diff_med}
abnb_sample_filtered %>%
  group_by(neighbourhood_group) %>%
  summarise(med_price = median(price))
```

The observed median prices for Manhattan and Brooklyn are $150.00 and $90.00, respectively. Therefore, the observed difference in median prices is $60.

Null Hypothesis: There is no difference in median price between Manhattan and Brooklyn Airbnb per night.

Alternative Hypothesis: There is a difference in median price between Manhattan and Brooklyn Airbnb per night.

```{r man-brook-med-price}
set.seed(111519)
null_dist_man_brook_med_price <- abnb_sample_filtered %>%
  specify(response = price, explanatory = neighbourhood_group) %>%
  hypothesize(null = "independence") %>%
  generate(reps = 1000, type = "permute") %>%
  calculate(stat = "diff in medians", order = c("Manhattan", "Brooklyn"))

```

Visualizing the null distribution.

```{r null_dist_diff_median_vis}
visualize(null_dist_man_brook_med_price) + 
  labs(title = "Null Dist of Difference in Median Price between Manhattan and Brooklyn") +
  shade_p_value(obs_stat = 60, direction = "two_sided")
```

Findng the p-value.

```{r null_dist_diff_median_p_val}
get_p_value(null_dist_man_brook_med_price, 60, direction = "two_sided")
```

The p-value is 0 which is less than the significance value of 0.05. Therefore, we reject the null hypothesis that there is no difference in median price between Manhattan and Brooklyn Airbnb per night. We can conclude that the data does provide convincing evidence of a difference in median price of Airbnbs for listings in Manhattan and Brooklyn.

### Part D

Creating new variable price_case which describes whether the price of the listing is above or below the median price:

```{r median_price-mutate}
abnb_sample <- abnb_sample %>%
   mutate(price_median = median(price), 
          price_case = case_when(
      price >= price_median ~ "Median or Above",
      price < price_median ~ "Below Median", 
    ))
```

Finding whether the prices at different longitudal and latitude co-ordinates in NYC are below or above the  median price:

```{r price-at-location}
abnb_sample %>%
  ggplot(mapping = aes (x = longitude, y = latitude, color = price_case)) +
  geom_jitter(alpha = 0.5) +
  labs(title = "Prices at Latitude and Longitude Coordinates", x = "Longitude", y = "Latitude", color = "Price Case")
```

Checking by boroughs:

```{r boroughs}
abnb_sample %>%
  count(neighbourhood_group, price_case) %>%
  group_by(neighbourhood_group) %>%
  mutate(rel_freq = n/sum(n)) %>%
  filter(price_case == "Median or Above")
```

WANT TO SAY WHETHER PRICE IS DEPENDEDNT ON LOCATION OF BOROUGH!

### Part E

```{r med-price-neighborhood}
abnb_sample %>%
  group_by(neighbourhood, neighbourhood_group) %>%
  summarise(med_price = median(price)) %>%
  arrange(desc(med_price)) %>%
  head(10)
```


### Part II

Second research question: How does the way in which a property is listed (type of room, for example) influence the availability of a listing?

```{r}
abnb_sample <- abnb_sample %>%
  mutate(availability_365_case = case_when(
      availability_365 <= 73  ~ "Low",
      availability_365 <= 143 & availability_365 > 73 ~ "Medium Low",
      availability_365 > 143 & availability_365 <= 219 ~ "Medium",
      availability_365 > 219 & availability_365 <= 292 ~ "Medium High",
      availability_365 > 292 ~ "High", 
    ))
```

```{r}
abnb_text <- abnb_sample %>%
  select(id, name, availability_365_case, availability_365)
```


```{r}
remove_reg <- "&amp;|&lt;|&gt;"
tidy_description <- abnb_text %>%
  mutate(name = str_remove_all(name, remove_reg)) %>%
  unnest_tokens(word, name)

tidy_description
```

```{r}
tidy_description <- tidy_description %>%
  filter(!word %in% stop_words $ word,
         !word %in% str_remove_all(stop_words$word, "'"),
         str_detect(word, "[a-z]"))

tidy_description %>%
  count(word, availability_365, sort = T) %>%
  arrange(availability_365) %>%
  head(10)
```


```{r}
frequency_all <- tidy_description %>%
  count(word, sort = T) %>%
  mutate(freq = n / sum(n)) 
```

```{r}
ggplot(frequency_all %>% top_n(10, freq) %>%
         mutate(word = reorder(word, freq)), aes(x = word, y = freq))+
  geom_col()+ 
  coord_flip()
```

```{r}
tidy_description %>%
  group_by(availability_365_case) %>%
  count(word, sort = T) %>% 
  filter(availability_365_case == "Low") %>%
  arrange(desc(n)) %>%
  head(10)
```


Creating a linear model to predict Airbnb availability by roomtype wth entire home/apt as be our baseline.

```{r lm-avail-room-type}
lm_avail_room_type <- lm(availability_365 ~ room_type, data = abnb_sample)

lm_avail_room_type %>% 
  tidy() %>% 
  select(term, estimate) %>%
  kable(format = "markdown", digits =3)

```

The linear model is:

`price-hat = 115.774 -3.443*(room_typePrivateroom) +74.912*(room_typeShared room)`

Intepreting the intercept:

Given that the Airbnb has the roomtype of entire house/apt the expected availability, on average, is 115.8 days out of the year. In this case, the intercept does have a meaningful interpretation because an Airbnb could be available for 121 days out of 365 per year.

Interpreting the slopes using lm_avail_room_type linear model:

For an Airbnb with roomtype of private room, the average availability is expected, on average, to be 3.4 days less per year than an Airbnb in wth room type of entire house/apt, holding all else constant.

For an Airbnb with roomtype of shared room, the average availability is expected, on average, to be 74.9 days more per year than an Airbnb in wth room type of entire house/apt, holding all else constant.


We are now going to add R^2 to our linear model above.

```{r rsqaure-lm_avail_room_typex}
glance(lm_avail_room_type)$r.squared
```

This means that roughly 0.841% of the variability in average availiability can be explained by the type of room of Airbnb in New York.



Constructing a bootstrap distribution for the median number of available days of Airbnbs in NYC:

```{r avail_boot_distribution_h}
set.seed(111519)
boot_dist_avail <- abnb_sample %>%
  specify(response = availability_365) %>%
  generate(reps = 1000, type = "bootstrap") %>%
  calculate(stat = "median")
```

Creating a 95% bootstrap confidence interval for the median number of available days of an Airbnb in NYC:

```{r boot_dist_availability_365}
(ci_bounds <- get_ci(boot_dist_avail, level= 0.95))
```

We are 95% confident that the median number of available days of Airbnbs in New York City is between 42 and 57 days.

Creating a visualization of the bootstrap distribution for median price:

```{r visualize_avail365}
visualize(boot_dist_avail) + 
  labs(title = "Bootstrap Dist of Median Number of Available Days of Airbnbs in NYC") +
  shade_ci(ci_bounds)
```


Removing NA values and creating a full model for availability_365:

```{r remove-na}
abnb_model <- abnb_sample %>%
  drop_na(availability_365,
          room_type, minimum_nights, 
          number_of_reviews,
          calculated_host_listings_count, 
          price_case, 
          reviews_per_month)

m_full_model <- lm(availability_365 ~ room_type + 
                     minimum_nights +  
                     number_of_reviews + 
                     calculated_host_listings_count + 
                     price_case + 
                     reviews_per_month, data = abnb_model)
```

Performing model selection using AIC for Availability:

```{r AIC-backward-selection, results="hide"}
selected_model <- step(m_full_model, direction = "backward")

tidy(selected_model) %>%
  select(term, estimate) %>%
  kable(format = "markdown", digits = 3)
```

The linear model for this model is:

`availability_365 = 59.923 + 26.396*(room_typePrivate room) + 115.98*(room_typeShared room) + 0.481*(minimum_nights) + 0.461*(number_of_reviews) + 0.853*(calculated_host_listings_count) + 29.622*(price_caseMedian or Above) + 5.93*(reviews_per_month)`

Determining R-squared:

```{r r-square}
glance(selected_model)$r.squared
```

The R-squared value is 10.49% of the variability in availibility can be explained by the way the property is listed - the room type, minimum nights required, number of reviews the listing has, the number of listings the host has, the median price and the reviews per month. 

Looking at the hosts by the number of listings they hold and classifying into "high volume" or "low volume":

```{r host-volume}
abnb_host_volume <- abnb_sample %>%
  mutate(host_volume = if_else(calculated_host_listings_count > 1, 
                               "high volume", "low volume")) %>%
  arrange(desc(calculated_host_listings_count))
```

Finding number of high volume hosts and low volume hosts:

```{r}
abnb_host_volume %>%
  count(host_volume)
```

Thus, 1355 of the hosts are high volume and 2645 of the hosts are low.

Conducting a hypothesis test if availability can be explained if someone is high volume or not:

Ho = median availability of high volume hosts is the same as that of low volume hosts

Ha = median availability of low volume hosts is the same as that of high volume hosts

```{r obs-med-avail}
abnb_host_volume %>%
  group_by(host_volume) %>%
  summarise(medianavail = 
              median(availability_365))
```


The observed median availability of high volume hosts is 180 and that of low volume hosts is 7. The observed sample median difference in availability is 180 - 7 = 173

Constructing null distribution:

```{r hypo-hostvolume}
set.seed(111519)
hypo_host_volume_listings <- abnb_host_volume %>%
  specify(response =  availability_365, 
          explanatory = host_volume) %>%
  hypothesize(null ="independence") %>%
  generate(reps = 1000, type = "permute") %>%
  calculate(stat = "diff in medians",
            order = c("high volume", "low volume"))
```

Visualizing null distribution:

```{r vis-hypo-hostvolume}
visualise(hypo_host_volume_listings) +
 labs(title = "Null distribution of differences in medians",
 subtitle = "sampmed_highvolume - sampmed_lowvolume") +
  shade_p_value(obs_stat = 173, 
                direction = "two_sided")
```

Calculating p-value:

```{r p-value-hypo-hostvolume}
hypo_host_volume_listings%>%
  filter(stat >= 173) %>%
  summarise(p_value = 2*n()/nrow(hypo_host_volume_listings))
```


The p-value is 0. Since the p-value of this hypothesis test is p < 0.05, we reject the null hypothesis in favor of the alternative. This means that there is significant evidence that there is a difference in the median availability of high volume hosts and low volume hosts.

...construct confidence interval if this makes sense...

This means there is a significant difference. Thus, to estimate the difference we construct a bootstrap simulation and find the 95% confidence interval.

Generating the bootstrap distribution:

```{r boot-hostvolume}
set.seed(111519)
boot_hostvolume <- abnb_host_volume %>%
  specify(response = availability_365,
          explanatory = host_volume) %>%
  generate(reps = 1000, type = "bootstrap") %>%
  calculate(stat = "diff in medians", 
            order = c("high volume", "low volume"))
```

Constructing 95% confidence interval for this difference in medians:

```{r ci-boot-hostvolume}
(cibounds1 <- get_ci(boot_hostvolume, level = 0.95))
```

Based on the results, we are 95% confident that the median availibility of the listings held by high volume hosts is between 165.98 to 200.012 higher than that of low volume hosts.

***
TO DO:
1. Add R squared for models we have
2. Bootstrap Distribution, Visualization, CI for Availability
3. Evertything (Room Type, Min Night, Number of Reviews, Calculated Host Listing, price_case, Reviews per month) AIC Model Selection for Availability — R squared and AIC Values
4. Host high volume or low volume
***
