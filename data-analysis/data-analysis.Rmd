---
title: "NYC Airbnb Popularity Factors"
author: "WORLD"
date: "12/3/2019"
output: github_document
---
    
### Load packages & data

Loaded the following packages that will be needed to perform analysis:

```{r load-packages, message=FALSE}
library(tidyverse) 
library(infer)
library(openintro)
library(dplyr)
library(knitr)
library(broom)
library(tidytext)
```

Uploaded the Airbnb data set from Kaggle via a csv file:

```{r load-data, message=FALSE}
abnb <- read_csv("AB_NYC_2019.csv")
```

We are assuming that the data we have for Airbnbs in New York City represents the population given that a) there are 48,895 observations and b) we concsulted Dr. Tackett and she thinks that the data was most likely web scapped from the Airbnb website. 

Therefore, in order to perform analysis, we used created a sample set called abnb_sample of 4000 randomly selected observations.

```{r abnb_sample}
set.seed(111519)
abnb_sample <- sample_n(abnb, 4000)
```

### Part I: Price and Location

In part I, the following research question will be examined: How does location (borough and neighborhood, for example) influence the price of a listing?

### Understanding Price

To start, a bootsrap distribution was constructed for the median price of Airbnbs in NYC. This will help to better understand the range of prices and the real estate landscape that the true median price would be within.

```{r boot-med_price}
set.seed(111519)
boot_dist_median_price <- abnb_sample %>%
  specify(response = price) %>%
  generate(reps = 1000, type = "bootstrap") %>%
  calculate(stat = "median")
```

Creating a 95% bootstrap confidence interval for the the median price of Airbnbs in NYC:

```{r boot_dist_median_priceci}
(ci_bounds <- get_ci(boot_dist_median_price, level= 0.95))
```

Creating a visualizaing of the bootstrap distribution for median price:

```{r boot_dist_median_visu}
visualize(boot_dist_median_price) + 
  labs(title = "Bootstrap Distribution of Median Price") +
  shade_ci(ci_bounds)
```

As depicted in the output and visualization, we are 95% confident that the population median price per night of Airbnbs in NYC is between $100.00 and $110.00. This information will help us understand prices in the Airbnb market as we go about attempting to draw comparisions.

### Exploring Boroughs and Resulting Analysis

The first location variable that might be helpful to explore is borough (neighbourhood_group) given that New York City is divided into five areas (The Bronx, Brooklyn, Manhattan, Queens, and Staten Island).

Creating an exploratory bar graph that displays number of listings by neighborhood borough in New York City:

```{r visualization-univariate}
ggplot(data = abnb, mapping = aes(x = neighbourhood_group)) +
  geom_bar() + 
  labs(title = "Listings by Borough", x = "Borough", y = "Count")
```

Manhattan and Brooklyn dominate the number of listings on Airbnb in New York City. More specifically, there is roughly 20,000 listings in Brooklyn and slightly more than 20,000 listings in Manhattan. Queens follows after with roughly 5,000 listings, followed by the Bronx and Staten Island with fewer than 1,100 listings each.

Calculating summary statistics that will count the number of listings in each neighborhood group:

```{r neighbourhood_group-count}
abnb %>%
  count(neighbourhood_group) %>%
  arrange(desc(n))
```

Manhattan has the most listings at 21,661 followed by Brooklyn at 20,104 listings, followed by Queens at 5,666, Bronx at 1,091, and Staten Island last at only 373 listings.

Creating summary statistics that displays the median price of each neighborhood group.

```{r summarise-price}
abnb %>%
  group_by(neighbourhood_group) %>%
  summarise(med_price = median(price)) %>%
  arrange(desc(med_price)) %>%
  head(5)
```

Manhattan has the highest median price at 150 followed by Brooklyn at 90, Queens and Staten Island at 75, and the Bronx last at 65. Therefore, we will develop a linear model to describe how boroughs influences price. Since Manhattan had the largest volume of Airbnbs and the highest median price, that will be the baseline for comparison with other boroughs.

Using fct_relevel to make Manhattan the baseline level for neighbourhood_group:

```{r mutate-neighbourhood_group}
abnb_sample <- abnb_sample %>%
  mutate(neighbourhood_group = fct_relevel(neighbourhood_group, 
                                           "Manhattan", 
                                           "Brooklyn",
                                           "Staten Island",
                                           "Queens",
                                           "Bronx"))
```

Creating a linear model to predict Airbnb price by borough:

```{r lm-price-borough}
lm_price_borough <- lm(price ~ neighbourhood_group, data = abnb_sample)

lm_price_borough %>% 
  tidy() %>% 
  select(term, estimate) %>%
  kable(format = "markdown", digits =3)

```

The linear model is:

`price-hat = 206.848 -85.106*(neighbourhood_groupBrooklyn) -117.674*(neighbourhood_groupStaten Island) -110.432*(neighbourhood_groupQueens) -126.213(neighbourhood_groupBronx)`

Given that the Airbnb is in Manhattan, the expected median price, on average, is $206.85. In this case, the intercept does have a meaningful interpretation because an Airbnb could have a price of $206.85 per night.

The median price for the other boroughs in relation in Manhattan is:

For an Airbnb in Brooklyn, the median price is expected, on average, to be $85.11 less than an Airbnb in Manhattan, holding all else constant.

For an Airbnb in Staten Island, the median price is expected, on average, to be $117.67 less than an Airbnb in Manhattan, holding all else constant.

For an Airbnb in Queens, the median price is expected, on average, to be $110.43 less than an Airbnb in Manhattan, holding all else constant.

For an Airbnb in Bronx, the median price is expected, on average, to be $126.21 less than an Airbnb in Manhattan, holding all else constant.

The R squared of the linear model lm_price_borough to evaulaute the variability explained by the model:

```{r rsqaure-lm_price_borough}
glance(lm_price_borough)$r.squared
```

Thus, roughly 3.670% of the variability in median price can be explained by the borough of Airbnbs in New York City.

### Comparing Manhattan and Brooklyn

We are suspicious that there might be a relationship between median price in Manhattan and Brooklyn because they contain the largest amount and the most expensive Airbnbs. Also, the linear model above showed that the expected difference of $85.11 in median price was the least between Brooklyn and Manhattan. Therefore we will attempt to answer the following: Is there is a significant difference in the true median prices between Manhattan and Brooklyn?

The abnb_sample was filtered to just include Manhattan and Brooklyn, which was saved to abnb_sample_filtered.

```{r filter-borough}
abnb_sample_filtered <- abnb_sample %>%
  filter(neighbourhood_group == "Manhattan" | neighbourhood_group == "Brooklyn")
```

Using the abnb_sample_filtered data frame, the observed sample median prices for Manhattand and Brooklyn were found.

```{r sample_diff_med}
abnb_sample_filtered %>%
  group_by(neighbourhood_group) %>%
  summarise(med_price = median(price))
```

The observed median prices for Manhattan and Brooklyn are $150.00 and $90.00, respectively. Therefore, the observed difference in median prices is $60.

With this observed difference a hypothesis test was conducted:

Null Hypothesis: There is no difference in median price between Manhattan and Brooklyn Airbnb per night.

Alternative Hypothesis: There is a difference in median price between Manhattan and Brooklyn Airbnb per night.

```{r man-brook-med-price}
set.seed(111519)
null_dist_man_brook_med_price <- abnb_sample_filtered %>%
  specify(response = price, explanatory = neighbourhood_group) %>%
  hypothesize(null = "independence") %>%
  generate(reps = 1000, type = "permute") %>%
  calculate(stat = "diff in medians", order = c("Manhattan", "Brooklyn"))

```

Visualizing the null distribution.

```{r null_dist_diff_median_vis, warning=FALSE}
visualize(null_dist_man_brook_med_price) + 
  labs(title = "Null Dist of Difference in Median Price between Manhattan and Brooklyn") +
  shade_p_value(obs_stat = 60, direction = "two_sided")
```

From the visualization, there appears to be no overlap between the shaded region and the null distribution. A p-value was found to confirm this:

```{r null_dist_diff_median_p_val}
get_p_value(null_dist_man_brook_med_price, 60, direction = "two_sided")
```

As expected, the p-value is 0, which is less than the significance value of 0.05. Therefore, we reject the null hypothesis that there is no difference in median price between Manhattan and Brooklyn Airbnb per night. We conclude that the data does provide convincing evidence of a difference in median price of Airbnbs for listings in Manhattan and Brooklyn.

Constructing a confidence interval to find the difference in median prices between Manhattan and Brooklyn:

```{r boot-man-brook-medprice}
boot_man_brook_medprice <- abnb_sample_filtered %>%
  specify(response = price, explanatory = neighbourhood_group) %>%
  generate(reps = 1000, type = "bootstrap") %>%
  calculate(stat = "diff in medians", c("Manhattan", "Brooklyn"))
```

```{r ci-boot}
(ci_bounds2 <- get_ci(boot_man_brook_medprice, level = 0.95))
```

We are 95% confident that the median price in Manhattan is between $55 and $65 higher than the median price in Brooklyn. 

### Visualizing Manhattan

From the previous sections, it has become clear that Manhattan is the most expensive borough for Airbnbs. In order to confirm this visually, we will create a scatterplot. To simply the scatterplot, price will be broken down into two catergories based on the median price of all Airbnbs in NYC.

Creating new variable price_case which describes whether the price of the listing is at or above the median price or below the median price:

```{r median_price-mutate}
abnb_sample <- abnb_sample %>%
   mutate(price_median = median(price), 
          price_case = case_when(
      price >= price_median ~ "Median or Above",
      price < price_median ~ "Below Median", 
    ))
```

Visualizing by latidude and longitude co-ordinates and using color to distinguish between the price types:

```{r price-at-location}
abnb_sample %>%
  ggplot(mapping = aes (x = longitude, y = latitude, color = price_case)) +
  geom_jitter(alpha = 0.5) +
  labs(title = "Prices at Latitude and Longitude Coordinates", x = "Longitude", y = "Latitude", color = "Price Case")
```

It is clear from this map, that the at the cases in which the prices are at the median or above (blue dots) are clustered around Manhattan. Therefore, visualization confirms our previous findings. The area that appears to have the second most number of blue dots is Brooklyn, which is right next to Manhattan. We use summary statistics to confirm. 

Relative frequency of listings that are above or at the median price by borough:

```{r boroughs-rel_freq}
abnb_sample %>%
  count(neighbourhood_group, price_case) %>%
  group_by(neighbourhood_group) %>%
  mutate(rel_freq = n/sum(n)) %>%
  filter(price_case == "Median or Above") %>%
  arrange(desc(rel_freq))
```

As visualized earlier, Manhattan has the greatest frequency of median or above listings at 68.757%, followed by Brooklyn at 40.380%. Queens has 24.448%, Staten Island has 21.739% and the Bronx has 15.294%.

### Neighborhood?

We have looked at the borough, latitude, and longitude co-ordinates so far. However, the final location indicator we have yet to take into account is neighborhood. We will calculate the median price of the top 10 neighborhoods and check their corresponding borough to see if they tend to lie in same borough, which we might expect to be Manhattan as it is the most expensive borough.

Summary statistic of median price by neighborhood:

```{r med-price-neighborhood}
abnb_sample %>%
  group_by(neighbourhood, neighbourhood_group) %>%
  summarise(med_price = median(price)) %>%
  arrange(desc(med_price)) %>%
  head(10)
```

It appears that the neighborhoods with the most expensive Airbnbs come from a range of boroughs. In fact, all are represented in the top 10 equally. Surprisingly, the Bronx contains the neighborhood, Eastchester, with the highest median price of $475.00. We will examine whether neighborhood has a significant influence on price by looking at an AIC selected linear model by backwards selection in the next section.

### Looking At Everything

### Part II

In part II, the following research question will be examined: How does the way in which a property is listed (type of room, for example) influence the availability of a listing?

Second research question: How does the way in which a property is listed (type of room, for example) influence the availability of a listing?

```{r}
abnb_sample <- abnb_sample %>%
  mutate(availability_365_case = case_when(
      availability_365 <= 73  ~ "Low",
      availability_365 <= 143 & availability_365 > 73 ~ "Medium Low",
      availability_365 > 143 & availability_365 <= 219 ~ "Medium",
      availability_365 > 219 & availability_365 <= 292 ~ "Medium High",
      availability_365 > 292 ~ "High", 
    ))
```

```{r}
abnb_text <- abnb_sample %>%
  select(id, name, availability_365_case, availability_365)
```


```{r}
remove_reg <- "&amp;|&lt;|&gt;"
tidy_description <- abnb_text %>%
  mutate(name = str_remove_all(name, remove_reg)) %>%
  unnest_tokens(word, name)

tidy_description
```

```{r}
tidy_description <- tidy_description %>%
  filter(!word %in% stop_words $ word,
         !word %in% str_remove_all(stop_words$word, "'"),
         str_detect(word, "[a-z]"))

tidy_description %>%
  count(word, availability_365, sort = T) %>%
  arrange(availability_365) %>%
  head(10)
```


```{r}
frequency_all <- tidy_description %>%
  count(word, sort = T) %>%
  mutate(freq = n / sum(n)) 
```

```{r}
ggplot(frequency_all %>% top_n(10, freq) %>%
         mutate(word = reorder(word, freq)), aes(x = word, y = freq))+
  geom_col()+ 
  coord_flip()
```

Creating a linear model to predict Airbnb availability by roomtype wth entire home/apt as be our baseline.

```{r lm-avail-room-type}
lm_avail_room_type <- lm(availability_365 ~ room_type, data = abnb_sample)

lm_avail_room_type %>% 
  tidy() %>%
  select(term, estimate) %>%
  kable(format = "markdown", digits =3)

```

The linear model is:

`price-hat = 115.774 -3.443*(room_typePrivateroom) +74.912*(room_typeShared room)`

Intepreting the intercept:

Given that the Airbnb has the roomtype of entire house/apt the expected availability, on average, is 115.8 days out of the year. In this case, the intercept does have a meaningful interpretation because an Airbnb could be available for 121 days out of 365 per year.

Interpreting the slopes using lm_avail_room_type linear model:

For an Airbnb with roomtype of private room, the average availability is expected, on average, to be 3.4 days less per year than an Airbnb in wth room type of entire house/apt, holding all else constant.

For an Airbnb with roomtype of shared room, the average availability is expected, on average, to be 74.9 days more per year than an Airbnb in wth room type of entire house/apt, holding all else constant.


We are now going to add R^2 to our linear model above.

```{r rsqaure-lm_avail_room_typex}
glance(lm_avail_room_type)$r.squared
```

This means that roughly 0.841% of the variability in average availiability can be explained by the type of room of Airbnb in New York.

NOTE DISCREPENCY AND ADD EXPLORATORY

Constructing a bootstrap distribution for the median number of available days of Airbnbs in NYC:

```{r avail_boot_distribution_h}
set.seed(111519)
boot_dist_avail <- abnb_sample %>%
  specify(response = availability_365) %>%
  generate(reps = 1000, type = "bootstrap") %>%
  calculate(stat = "median")
```

Creating a 95% bootstrap confidence interval for the median number of available days of an Airbnb in NYC:

```{r boot_dist_availability_365}
(ci_bounds <- get_ci(boot_dist_avail, level= 0.95))
```

We are 95% confident that the median number of available days of Airbnbs in New York City is between 42 and 57 days.

Creating a visualization of the bootstrap distribution for median price:

```{r visualize_avail365}
visualize(boot_dist_avail) + 
  labs(title = "Bootstrap Dist of Median Number of Available Days of Airbnbs in NYC") +
  shade_ci(ci_bounds)
```


Removing NA values and creating a full model for availability_365:

```{r remove-na}
abnb_model <- abnb_sample %>%
  drop_na(availability_365,
          room_type, minimum_nights, 
          number_of_reviews,
          calculated_host_listings_count, 
          price_case, 
          reviews_per_month)

m_full_model <- lm(availability_365 ~ room_type + 
                     minimum_nights +  
                     number_of_reviews + 
                     calculated_host_listings_count + 
                     price_case + 
                     reviews_per_month, data = abnb_model)
```

Performing model selection using AIC for Availability:

```{r AIC-backward-selection, results="hide"}
selected_model <- step(m_full_model, direction = "backward")

tidy(selected_model) %>%
  select(term, estimate) %>%
  kable(format = "markdown", digits = 3)
```

The linear model for this model is:

`availability_365 = 59.923 + 26.396*(room_typePrivate room) + 115.98*(room_typeShared room) + 0.481*(minimum_nights) + 0.461*(number_of_reviews) + 0.853*(calculated_host_listings_count) + 29.622*(price_caseMedian or Above) + 5.93*(reviews_per_month)`

Determining R-squared:

```{r r-square}
glance(selected_model)$r.squared
```

The R-squared value is 10.49% of the variability in availibility can be explained by the way the property is listed - the room type, minimum nights required, number of reviews the listing has, the number of listings the host has, the median price and the reviews per month. 

INTERPRET SLOPES 

PART 3

- lets add what it tells us about the renter - profile 

Looking at the hosts by the number of listings they hold and classifying into "high volume" or "low volume":

```{r host-volume}
abnb_host_volume <- abnb_sample %>%
  mutate(host_volume = if_else(calculated_host_listings_count > 1, 
                               "high volume", "low volume")) %>%
  arrange(desc(calculated_host_listings_count))
```

Finding number of high volume hosts and low volume hosts:

```{r}
abnb_host_volume %>%
  count(host_volume)
```

Thus, 1355 of the hosts are high volume and 2645 of the hosts are low.

Conducting a hypothesis test if availability can be explained if someone is high volume or not:

Ho = median availability of high volume hosts is the same as that of low volume hosts

Ha = median availability of low volume hosts is the same as that of high volume hosts

```{r obs-med-avail}
abnb_host_volume %>%
  group_by(host_volume) %>%
  summarise(medianavail = 
              median(availability_365))
```


The observed median availability of high volume hosts is 180 and that of low volume hosts is 7. The observed sample median difference in availability is 180 - 7 = 173

Constructing null distribution:

```{r hypo-hostvolume}
set.seed(111519)
hypo_host_volume_listings <- abnb_host_volume %>%
  specify(response =  availability_365, 
          explanatory = host_volume) %>%
  hypothesize(null ="independence") %>%
  generate(reps = 1000, type = "permute") %>%
  calculate(stat = "diff in medians",
            order = c("high volume", "low volume"))
```

Visualizing null distribution:

```{r vis-hypo-hostvolume}
visualise(hypo_host_volume_listings) +
 labs(title = "Null distribution of differences in medians",
 subtitle = "sampmed_highvolume - sampmed_lowvolume") +
  shade_p_value(obs_stat = 173, 
                direction = "two_sided")
```

Calculating p-value:

```{r p-value-hypo-hostvolume}
hypo_host_volume_listings%>%
  filter(stat >= 173) %>%
  summarise(p_value = 2*n()/nrow(hypo_host_volume_listings))
```


The p-value is 0. Since the p-value of this hypothesis test is p < 0.05, we reject the null hypothesis in favor of the alternative. This means that there is significant evidence that there is a difference in the median availability of high volume hosts and low volume hosts.

...construct confidence interval if this makes sense...

This means there is a significant difference. Thus, to estimate the difference we construct a bootstrap simulation and find the 95% confidence interval.

Generating the bootstrap distribution:

```{r boot-hostvolume}
set.seed(111519)
boot_hostvolume <- abnb_host_volume %>%
  specify(response = availability_365,
          explanatory = host_volume) %>%
  generate(reps = 1000, type = "bootstrap") %>%
  calculate(stat = "diff in medians", 
            order = c("high volume", "low volume"))
```

Constructing 95% confidence interval for this difference in medians:

```{r ci-boot-hostvolume}
(cibounds1 <- get_ci(boot_hostvolume, level = 0.95))
```

Based on the results, we are 95% confident that the median availibility of the listings held by high volume hosts is between 165.98 to 200.012 higher than that of low volume hosts.

***
TO DO:
1. Add R squared for models we have ---> Done (Brandon)
2. Bootstrap Distribution, Visualization, CI for Availability ---> Done (Brandon)
3. Evertything (Room Type, Min Night, Number of Reviews, Calculated Host Listing, price_case, Reviews per month) AIC Model Selection for Availability — R squared and AIC Values
4. Host high volume or low volume
5. Hypothesis testing, visualization of p-value on the difference between Staten island and queens because they're so close to each other ---> Done (Brandon)
6. I want to do more on the text analysis as I think this is a brilliant idea by Ellie/Drew and key to making our project stand out relative to others --- what if we do hypothesis testing on the true difference in price listing between the word "spacious" and "cozy" as these seem to be polar opposite descriptive words yet they are very common? ---> In Debate/Progress (Brandon)
***

```{r}
abnb_sample <- abnb_sample %>%
  select(-(id))
```

```{r}
abnb_test <- abnb_sample %>%
  count(host_id) %>%
  mutate(host_volume = if_else(n> 1, "high volume", "low volume"))
```


```{r}
abnb_test <- abnb_test %>%
  inner_join(abnb_sample, by = "host_id") %>%
  arrange(desc(n))
```



AIC for everything price/availability